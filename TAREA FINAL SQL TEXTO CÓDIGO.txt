-- 1º PASO ANTES DE COMENZAR LA TAREA ES CONOCER MI BASE DE DATOS

SELECT * FROM SALES;

SELECT * FROM ACCOUNTS;

SELECT * FROM FORECASTS;


-- HIPÓTESIS

-- Nuestra hipótesis trata acerca de una empresa especializada en un área muy concreta, en este caso, soluciones ergonómicas tecnológicamente avanzadas para el mobiliario de oficina. 
-- Esta empresa está en plena fase de expansión, por ello, necesita de una serie de data que le aporte valor y que le ayude a diseñar su estrategia de venta, con el objetivo de poder crecer a nivel internacional, 

-- VAMOS A OBTENER UNA SERIE DE ESTADÍSTICOS SOBRE LA DATA PARA EL CASO PRÁCTICO Y PARA PONERNOS EN CONTEXTO

-- 1º 
SELECT
    S.YEAR,
    COUNT(S.*) AS "TOTAL VENTAS",
    ROUND(AVG(S.UNITS_SOLD),2) AS "PROMEDIO UNIDADES VENDIDAS",
    ROUND(STDDEV(S.UNITS_SOLD),2) AS "DESVIACION TIPICA",
    COUNT(DISTINCT A.ACCOUNT) AS "NUMERO CLIENTES"
FROM SALES S
LEFT JOIN ACCOUNTS A ON S.ACCOUNT = A.ACCOUNT
GROUP BY YEAR
ORDER BY YEAR ASC;

-- 2º 
SELECT 
    DISTINCT ACCOUNT,
FROM FORECASTS
ORDER BY ACCOUNT DESC;
    
-- 3º
SELECT
    S.YEAR,
    S.QUARTER_OF_YEAR AS TRIMESTRE,
    S.ACCOUNT AS CLIENTE,
    S.CATEGORY,
    SUM(S.TOTAL) AS INGRESOS,
    SUM(S.UNITS_SOLD) AS "UDS VENDIDAS",
    SUM(S.PROFIT) AS BENEFICIO,
    A.COUNTRY AS PAIS,
    SUM(S.MAINTENANCE + S.PARTS + S.SUPPORT) AS "SERVICIOS COMPLEMENTARIOS",
    A.INDUSTRY AS SECTOR
FROM SALES S
LEFT JOIN ACCOUNTS A ON S.ACCOUNT = A.ACCOUNT
GROUP BY S.YEAR, S.QUARTER_OF_YEAR, S.ACCOUNT, S.CATEGORY, A.COUNTRY, A.INDUSTRY
ORDER BY YEAR, QUARTER_OF_YEAR ASC;

-- 4º
SELECT
    S.YEAR AS "AÑO",
    S.ACCOUNT AS CLIENTE,
    S.CATEGORY AS CATEGORIA,
    S.PROFIT AS "BENEFICIO TOTAL",
    S.UNITS_SOLD AS "UNIDADES VENDIDAS",
    A.COUNTRY AS "PAIS",
    A.REGION
FROM SALES S
LEFT JOIN ACCOUNTS A ON S.ACCOUNT = A.ACCOUNT
WHERE S.ACCOUNT = 'Reidwo Consulting'
GROUP BY S.YEAR, S.ACCOUNT, S.CATEGORY, S.PROFIT, S.UNITS_SOLD, A.COUNTRY, A.REGION
ORDER BY S.PROFIT DESC;
 
-- 5º
SELECT
    S.YEAR,
    S.CATEGORY,
    S.MAINTENANCE,
    S.PARTS,
    S.PRODUCT,
    S.SUPPORT,
    A.COUNTRY,
    A.REGION,
    A.INDUSTRY
FROM SALES S
LEFT JOIN ACCOUNTS A ON S.ACCOUNT = A.ACCOUNT
GROUP BY S.YEAR, S.CATEGORY, S.MAINTENANCE, S.PARTS, S.PRODUCT, S.SUPPORT, A.COUNTRY, A.REGION, A.INDUSTRY
ORDER BY S.YEAR; 

-- EJERCICIOS

-- EJERCICIO 1
SELECT 
    CATEGORY AS CATEGORIA,
    SUM(PRODUCT) AS PRODUCTO,
    SUM(MAINTENANCE) AS MANTENIMIENTO,
    SUM(SUPPORT) AS SOPORTE,
    SUM(PARTS) AS REPUESTOS,
    SUM(UNITS_SOLD) AS "UNIDADES VENDIDAS",
    ROUND(AVG(PROFIT), 2) AS "PROMEDIO BENEFICIO"
FROM SALES
WHERE ACCOUNT = 'Abbot Industries' AND YEAR = 2020
GROUP BY CATEGORIA
ORDER BY "UNIDADES VENDIDAS" DESC;



-- EJERCICIO 2
SELECT
    F.CATEGORY AS CATEGORIA,
    SUM(F.FORECAST_PROFIT) AS "PRONOSTICO 2022",
    (SELECT SUM(S.PROFIT)
     FROM SALES S
     WHERE S.CATEGORY = F.CATEGORY AND S.QUARTER = '2021 Q3') AS "BENEFICIO 2021 Q3",
    (SELECT SUM(S.PROFIT)
     FROM SALES S
     WHERE S.CATEGORY = F.CATEGORY AND S.QUARTER = '2020 Q1') AS "BENEFICIO 2020 Q1",
     MIN(F.OPPORTUNITY_AGE) AS "MINIMO OPORTUNIDAD",
     MAX(F.OPPORTUNITY_AGE) AS "MAXIMO OPORTUNIDAD"
FROM FORECASTS F
WHERE F.YEAR = 2022
GROUP BY CATEGORY
ORDER BY "BENEFICIO 2020 Q1" DESC;

    
-- EJERCICIO 3
SELECT
    A.COUNTRY AS PAIS, 
    A.REGION AS REGION,
    A.INDUSTRY AS SECTOR, 
    SUM(S.UNITS_SOLD) AS "UNIDADES VENDIDAS",
    SUM(PROFIT) AS "BENEFICIO TOTAL",
    ROUND(AVG(PROFIT),2) AS "BENEFICIO PROMEDIO",
    SUM(TOTAL) AS "INGRESO TOTAL"
FROM SALES S
LEFT JOIN ACCOUNTS A ON S.ACCOUNT = A.ACCOUNT
WHERE A.REGION IN ('APAC', 'EMEA')
GROUP BY A.COUNTRY, A.REGION, A.INDUSTRY
ORDER BY SUM(PROFIT) DESC;


--EJERCICIO 4
SELECT
    SUM(S.PROFIT) AS "BENEFICIO TOTAL",
    A.INDUSTRY AS "SECTOR",
    CASE
        WHEN SUM(S.PROFIT) > 1000000 THEN 'ALTO'
        ELSE 'BAJO'
    END AS CLASIFICACION_BENEFICIO
FROM SALES S
LEFT JOIN ACCOUNTS A ON S.ACCOUNT = A.ACCOUNT
WHERE A.INDUSTRY IN (
    SELECT
        A.INDUSTRY
    FROM FORECASTS F
    JOIN ACCOUNTS A ON F.ACCOUNT = A.ACCOUNT
    JOIN SALES S ON A.ACCOUNT = S.ACCOUNT
    GROUP BY A.INDUSTRY
    HAVING SUM(S.PROFIT) > 500000
)
GROUP BY A.INDUSTRY
ORDER BY "BENEFICIO TOTAL" DESC;


-- EJERCICIO 5
SELECT 
    IQW.INDUSTRY AS SECTOR,
    IQW.QUARTER AS TRIMESTRE,
    SUM(IQW.PROFIT) AS BENEFICIO,
    SUM(IQW.BENEFICIO_ACUMULADO) AS "BENEFICIO ACUMULADO",
    SUM(IQW.FORECAST_PROFIT) AS PRONOSTICO,
    MIN(IQW.OPPORTUNITY_AGE) "OPORTUNIDAD RECIENTE",
    MAX(IQW.OPPORTUNITY_AGE) "OPORTUNIDAD ANTIGUA"
FROM INDUSTRY_QUARTER_WINDOW AS IQW
GROUP BY IQW.INDUSTRY, IQW.QUARTER
ORDER BY TRIMESTRE, SECTOR;